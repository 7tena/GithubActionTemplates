name: Hello message on pull request.
# https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context
# the pull request target event provides RW token to github 
# https://github.blog/2020-08-03-github-actions-improvements-for-fork-and-pull-request-workflows/
# pull_request_target is only raised when a pull request is raised from a fork
# https://securitylab.github.com/research/github-actions-preventing-pwn-requests/

on: 
  pull_request_target:
    branches:
      - main

jobs:
  one:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8]

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 100
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Setting temp directory
        run: | 
          mkdir ./.tmp
      - name: Getting commit details
        uses: wei/wget@v1
        with:
          args: -O ./.tmp/commitDetails.json ${{ toJSON(github.event.pull_request._links.commits.href) }}
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
        run: | 
          echo "$GITHUB_CONTEXT" > ./.tmp/github.json
          cat ./.tmp/github.json
          echo "commit details: "
          cat ./.tmp/commitDetails.json
      - name: Comment on pull request
        run: |
          pip install PyGithub
          which git
          if ! python ./.github/workflows/python/pull_request_comment.py; then
              echo "Pull request details could not be extracted"
              exit 1
          else
              echo "all good"
          fi
      